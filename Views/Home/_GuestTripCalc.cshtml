@model Carzi.Models.ViewModels.TripCalculatorViewModel

<form id="tripForm">
    <!-- Base vehicle info -->
    <div class="mb-3">
        <label class="form-label">Distance (km)</label>
        <input type="number" id="distance" class="form-control" placeholder="e.g. 120" required>
    </div>

    <div class="mb-3">
        <label class="form-label">Fuel Consumption (L / 100km)</label>
        <input type="number" id="consumption" class="form-control" placeholder="e.g. 7.5" required>
    </div>

    <!-- Fuel -->
    <div class="mb-3">
        <label class="form-label">Fuel Type</label>
        <select id="fuelType" class="form-select">
        @foreach (var fuel in Model.Fuels)
        {
            <option value="@fuel.Id"
                    data-price="@fuel.PricePerLiter">
                    @fuel.Name
            </option>
        }
        </select>
    </div>

    <div class="mb-3">
        <label class="form-label">Fuel Price (€ / liter)</label>
        <input type="number" id="fuelPrice" class="form-control" placeholder="e.g. 1.25" required>
    </div>

    <!-- Is vignette needed check-->
    <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="hasVignette">
        <label class="form-check-label">
            Have a valid vignette or driving a motorcycle?
        </label>
    </div>

    <!-- Vignette selection -->
    <div id="vignetteSection">

        <div class="mb-3">
            <label class="form-label">Trip Start</label>
            <input type="date" id="startDate" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Trip End</label>
            <input type="date" id="endDate" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Vignette Type</label>
            <select id="vignetteType" class="form-select">
            @foreach (var v in Model.Vignettes)
            {
                <option value="@v.Price" data-days="@v.ValidityDays">
                    @v.Name (€@v.Price)
                </option>
            }
            </select>
        </div>

    </div>

    <button type="button" class="btn btn-primary" onclick="calculateCost()">
        Calculate
    </button>
</form>

<hr />

<div id="result" class="alert alert-success d-none fs-5"></div>

<p class="text-muted">
    Note: This calculation is not saved.
</p>

<script>
    let vignetteManuallyChanged = false;

    const vignetteSection = document.getElementById("vignetteSection");
    const hasVignette = document.getElementById("hasVignette");
    const vignetteSelect = document.getElementById("vignetteType");

    const startDateInput = document.getElementById("startDate");
    const endDateInput = document.getElementById("endDate");

    startDateInput.addEventListener("change", () => {
        vignetteManuallyChanged = false;
    });

    endDateInput.addEventListener("change", () => {
        vignetteManuallyChanged = false;
    });

    vignetteSelect.addEventListener("change", () => {
        vignetteManuallyChanged = true;
    });

    hasVignette.addEventListener("change", () => {
        vignetteSection.style.display = hasVignette.checked ? "none" : "block";
    });

    let fuelPriceManuallyChanged = false;

    const fuelSelect = document.getElementById("fuelType");
    const fuelPriceInput = document.getElementById("fuelPrice");

    // When fuel changes → update price
    fuelSelect.addEventListener("change", () => {
        const selected = fuelSelect.options[fuelSelect.selectedIndex];

        // Reset manual override when fuel type changes
        fuelPriceManuallyChanged = false;

        // Load DB price for selected fuel
        fuelPriceInput.value =
            parseFloat(selected.dataset.price).toFixed(2);
    });


    // Check for manual override of fuel price
    fuelPriceInput.addEventListener("input", () => {
        fuelPriceManuallyChanged = true;
    });

    function calculateCost() {

        const distance = parseFloat(document.getElementById("distance").value);
        const consumption = parseFloat(document.getElementById("consumption").value);
        
        let fuelPrice = parseFloat(fuelPriceInput.value);

        if (isNaN(fuelPrice)) {
            const selectedFuel =
                fuelSelect.options[fuelSelect.selectedIndex];

            fuelPrice = parseFloat(selectedFuel.dataset.price);
        }

        if (isNaN(distance) || isNaN(consumption)) {

            alert("Please fill in all required fields.");
            return;
        }

        const fuelCost = (distance / 100) * consumption * fuelPrice;

        let vignetteCost = 0;

        if (!hasVignette.checked) {
            const start = new Date(document.getElementById("startDate").value);
            const end = new Date(document.getElementById("endDate").value);

            if (!start || !end || end < start) {
                alert("Please select a valid trip date range.");
                return;
            }

            // Trip duration in days
            const days =
                Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

            // Suggest correct vignette type based on duration
            const suggested = getSuggestedVignette(days);

            if (!vignetteManuallyChanged) {
                vignetteSelect.value = suggested.value;
            }

            vignetteCost = parseFloat(vignetteSelect.value);
        }

        const total = fuelCost + vignetteCost;

        const result = document.getElementById("result");
        result.classList.remove("d-none");
        result.innerHTML = `
            <strong>Total cost:</strong> €${total.toFixed(2)}<br>
            Fuel: €${fuelCost.toFixed(2)}<br>
            Vignette: €${vignetteCost.toFixed(2)}
        `;
    }

    function getSuggestedVignette(days) {
        const options = document.querySelectorAll("#vignetteType option");

        for (let opt of options) {
            if (days <= parseInt(opt.dataset.days)) {
                return opt;
            }
        }
        return options[options.length - 1];
    }

    function updateVignetteVisibility() {
        vignetteSection.style.display = hasVignette.checked ? "none" : "block";
    }

    hasVignette.addEventListener("change", updateVignetteVisibility);

    // Run once on page load
    updateVignetteVisibility();

    // Initialize fuel price from first option
    window.addEventListener("load", () => {
        const firstFuel =
            fuelSelect.options[fuelSelect.selectedIndex];

        fuelPriceInput.value =
            parseFloat(firstFuel.dataset.price).toFixed(2);
    });

</script>
